{% extends 'base.html' %}

{% block body %}
<div class="container mt-5 pt-5">
    <div class="card mx-auto shadow" style="max-width: 700px;">
        <div class="card-body">
            <h2 class="card-title text-center mb-4"><strong>{{ viagem.destino }}</strong></h2>
            
            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                <h5 class="mb-0">Atividades Planejadas</h5>
                <span class="badge bg-dark">{{ viagem.atividades|length }} itens</span>
            </div>
            
            {% if viagem.atividades %}
                <ul class="list-group list-group-flush mb-4">
                    {% for atividade in viagem['atividades'] %}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <span class="fw-bold">{{ atividade['nome_atividade'] }}</span>
                                <br>
                                <small class="text-muted">R$ {{ "%.2f"|format(atividade['valor_atividade']|float) }}</small>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('atividade_detalhe', id_viagem=viagem.doc_id, id_atividade=atividade['doc_id']) }}" 
                                   class="btn btn-outline-dark btn-sm">Editar</a>
                                
                                <form action="{{ url_for('excluir_atividade', id_viagem=viagem.doc_id, id_atividade=atividade['doc_id']) }}" method="POST" style="display:inline;">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Excluir esta atividade?');">
                                        Excluir
                                    </button>
                                </form>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted text-center my-4 italic">Nenhuma atividade cadastrada ainda. Comece adicionando uma!</p>
            {% endif %}

            <div class="bg-light p-3 rounded mb-4">
                <table class="table table-sm table-borderless mb-0">
                    <tbody>
                        <tr>
                            <th class="text-start">Orçamento Total:</th>
                            <td class="text-end fw-bold">R$ {{ "%.2f"|format(viagem.valor_total) }}</td>
                        </tr>
                        <tr>
                            <th class="text-start">Valor Restante:</th>
                            <td class="text-end fw-bold text-success">R$ {{ "%.2f"|format(viagem.valor_restante) }}</td>
                        </tr>
                    </tbody>
                </table>

                {% if viagens_com_percentual %}
                    {% for item in viagens_com_percentual if item.viagem.doc_id == viagem.doc_id %}
                        <div class="mt-3">
                            <small class="text-muted">Percentual do orçamento utilizado:</small>
                            <div class="progress mt-1" style="height: 25px; border-radius: 12px;">
                                <div class="progress-bar {{ item.cor }} progress-bar-striped" role="progressbar"
                                    style="width: {{ item.percentual_gasto if item.percentual_gasto <= 100 else 100 }}%;"
                                    aria-valuenow="{{ item.percentual_gasto }}"
                                    aria-valuemin="0" aria-valuemax="100">
                                    <strong>{{ "%.1f"|format(item.percentual_gasto) }}%</strong>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="d-flex justify-content-center gap-3">
                <a href="{{ url_for('perfil') }}" class="btn btn-secondary">Voltar</a>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAtividade">
                    + Nova Atividade
                </button>
            </div>
        </div>

        <div class="card-footer bg-white d-flex justify-content-center gap-3 py-3">
            <a href="{{ url_for('editar_viagem', id_viagem=viagem.doc_id) }}" class="btn btn-link btn-sm text-dark">
                Editar Destino/Orçamento
            </a>
            <form action="{{ url_for('deletar_viagem', viagem_id=viagem.doc_id) }}" method="POST">
                <button type="submit" class="btn btn-link btn-sm text-danger" onclick="return confirm('ATENÇÃO: Isso apagará a viagem e todas as atividades. Confirmar?');">
                    Excluir Viagem
                </button>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAtividade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title w-100 text-center">Nova Atividade para {{ viagem.destino }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form method="POST">
            {{ form_atividade.hidden_tag() }}
            <div class="mb-3">
                {{ form_atividade.nome_atividade.label(class="form-label") }}
                {{ form_atividade.nome_atividade(class="form-control", placeholder="Ex: Jantar no Louvre") }}
            </div>
            <div class="mb-3">
                {{ form_atividade.valor_atividade.label(class="form-label") }}
                <div class="input-group">
                    <span class="input-group-text">R$</span>
                    {{ form_atividade.valor_atividade(class="form-control", placeholder="0.00") }}
                </div>
            </div>
            <div class="d-grid">
                {{ form_atividade.submit_atividade(class="btn btn-primary") }}
            </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}